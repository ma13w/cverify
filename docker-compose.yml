# CVerify - Full Stack Deployment
# Relay Server + Public Application
version: "3.8"

services:
  relay-server:
    build:
      context: .
      dockerfile: ./relay-server/Dockerfile
    container_name: cverify-relay
    restart: unless-stopped
    ports:
      - "${RELAY_PORT:-7070}:8080"
    volumes:
      # Persist relay data
      - relay_data:/var/www/html/data
      # Optional: Custom config
      - ./relay-server/settings.php:/var/www/html/settings.php:ro
    environment:
      - PHP_OPCACHE_ENABLE=1
      - APACHE_RUN_USER=www-data
      - APACHE_RUN_GROUP=www-data
    networks:
      - cverify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    labels:
      - "com.cverify.service=relay"
      - "com.cverify.description=Central relay server"

networks:
  cverify-network:
    driver: bridge

volumes:
  relay_data:
    driver: local
  user_data:
    driver: local
  company_data:
    driver: local
